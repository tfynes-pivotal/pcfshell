#!/bin/bash
TMPDIR=/tmp
#if [[ $# -ne 3 ]] ; then echo 'usage: clone <New ShellName> <username> <password>'
if (($# < 3)) || (($# > 4)) ; then echo 'usage: clone <New ShellName> <username> <password> [DiskQuota(GB)=2]'
    exit 1
fi
if (( $# == 4 )); then
  DiskQuota=$4
fi

# copy files into tmp folder - skipping exploded folders and large binaries
mytemp=$(mktemp -d)
rsync -a /home/vcap/app $mytemp --exclude app/bin/jdk-11.0.1 --exclude app/bin/jdk-11.0.1.tgz --exclude app/bin/pivotal-gemfire-9.3.0 --exclude app/bin/pivotal-gemfire-9.3.0.tgz --exclude app/bin/pivotal-gemfire-9.3.0 --exclude app/bin/rubygems --exclude app/bin/rubygems.tgz --exclude app/bin/libs/usr

# link large binaries to target folder (saves disk space)
ln /home/vcap/app/bin/jdk-11.0.1.tgz $mytemp/app/bin/jdk-11.0.1.tgz
ln /home/vcap/app/bin/jdk-11.0.1.tgz $mytemp/app/bin/pivotal-gemfire-9.3.0.tgz
ln /home/vcap/app/bin/jdk-11.0.1.tgz $mytemp/app/bin/rubygems.tgz

# replace username/password
cp $mytemp/app/bin/haproxy/haproxy.config.original $mytemp/app/bin/haproxy/haproxy.config
sed -i "s/.*insecure-password.*/ user $2 insecure-password $3/" $mytemp/app/bin/haproxy/haproxy.config
cp $mytemp/app/Procfile.original $mytemp/app/Procfile
sed -r -i "s/(.*)pivotaluser:pivotalpass(.*)/\1$2:$3\2/" $mytemp/app/Procfile


# push cloned application
pushd $mytemp/app
if [ -n "$DiskQuota" ]; then
  G="G"
  cf push $1 -b binary_buildpack -k $DiskQuota$G
else
  cf push $1 -b binary_buildpack -k 2G
fi
popd
rm -fr $mytemp
